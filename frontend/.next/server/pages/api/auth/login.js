"use strict";(()=>{var e={};e.id=143,e.ids=[143],e.modules={829:e=>{e.exports=require("jsonwebtoken")},3139:e=>{e.exports=import("bcryptjs")},3480:(e,r,t)=>{e.exports=t(5600)},3761:e=>{e.exports=import("@vercel/blob")},5117:(e,r,t)=>{t.a(e,async(e,s)=>{try{t.r(r),t.d(r,{default:()=>c});var n=t(3761),o=t(3139),a=t(829),i=t.n(a),u=e([n,o]);[n,o]=u.then?(await u)():u;let l=process.env.JWT_SECRET||"your-secret-key-change-in-production";async function c(e,r){if("POST"!==e.method)return r.status(405).json({success:!1,error:"Method not allowed"});try{let{username:t,password:s,rememberMe:a}=e.body,u=(t||"").trim().toLowerCase(),c=process.env.BLOB_READ_WRITE_TOKEN;if(!c){let e=Object.keys(process.env).find(e=>e.includes("BLOB")&&e.includes("READ_WRITE_TOKEN"));e&&(c=process.env[e])}if(!c)return r.status(500).json({success:!1,error:"إعداد التخزين مفقود: يرجى ضبط المتغير BLOB_READ_WRITE_TOKEN في البيئة (ملف .env.local) ثم إعادة تشغيل الخادم."});if(!u||!s)return r.status(400).json({success:!1,error:"اسم المستخدم وكلمة المرور مطلوبان"});let d="users.json";try{let{blobs:e}=await (0,n.list)({token:c}),t=e.find(e=>e.pathname===d),f=[];if(t){let e=await fetch(t.url);f=await e.json()}let p=f.find(e=>(e.username||"").trim().toLowerCase()===u&&e.isActive);if(!p||!await o.default.compare(s,p.password))return r.status(401).json({success:!1,error:"اسم المستخدم أو كلمة المرور غير صحيحة"});let A={userId:p.id,username:p.username,role:p.role,officeId:p.officeId},m=i().sign(A,l,{expiresIn:a?"30d":"24h"});p.lastLogin=new Date,await (0,n.put)(d,JSON.stringify(f,null,2),{access:"public",addRandomSuffix:!1,token:c});let P={success:!0,user:{id:p.id,username:p.username,email:p.email,password:"",role:p.role,parentUserId:p.parentUserId,officeId:p.officeId,createdAt:p.createdAt,lastLogin:p.lastLogin,isActive:p.isActive},token:m,message:"تم تسجيل الدخول بنجاح"};return r.status(200).json(P)}catch(e){return console.error("Blob error:",e),r.status(500).json({success:!1,error:"خطأ في قاعدة البيانات"})}}catch(e){return console.error("Login error:",e),r.status(500).json({success:!1,error:"خطأ داخلي في الخادم"})}}s()}catch(e){s(e)}})},5600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6435:(e,r)=>{Object.defineProperty(r,"M",{enumerable:!0,get:function(){return function e(r,t){return t in r?r[t]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,t)):"function"==typeof r&&"default"===t?r:void 0}}})},8667:(e,r)=>{Object.defineProperty(r,"A",{enumerable:!0,get:function(){return t}});var t=function(e){return e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE",e.IMAGE="IMAGE",e}({})},8688:(e,r,t)=>{t.a(e,async(e,s)=>{try{t.r(r),t.d(r,{config:()=>l,default:()=>c,routeModule:()=>d});var n=t(3480),o=t(8667),a=t(6435),i=t(5117),u=e([i]);i=(u.then?(await u)():u)[0];let c=(0,a.M)(i,"default"),l=(0,a.M)(i,"config"),d=new n.PagesAPIRouteModule({definition:{kind:o.A.PAGES_API,page:"/api/auth/login",pathname:"/api/auth/login",bundlePath:"",filename:""},userland:i});s()}catch(e){s(e)}})}};var r=require("../../../webpack-api-runtime.js");r.C(e);var t=r(r.s=8688);module.exports=t})();