# دليل إعداد نظام المصادقة في Supabase

## الخطوات المطلوبة

### 1. إعداد قاعدة البيانات في Supabase

1. اذهب إلى [Supabase Dashboard](https://supabase.com/dashboard)
2. اختر مشروعك: `supabase-teal-garden`
3. اذهب إلى **SQL Editor**
4. انسخ محتوى ملف `supabase-auth-setup.sql` والصقه في المحرر
5. اضغط **Run** لتنفيذ الأوامر

### 2. إنشاء الجداول

سيتم إنشاء الجداول التالية:

#### جدول المكاتب (offices)
- `id`: معرف فريد
- `name`: اسم المكتب (فريد)
- `created_at`: تاريخ الإنشاء
- `updated_at`: تاريخ التحديث

#### جدول المستخدمين (users)
- `id`: معرف فريد
- `username`: اسم المستخدم (فريد)
- `email`: البريد الإلكتروني (فريد)
- `password_hash`: كلمة المرور مشفرة
- `role`: دور المستخدم (user/admin)
- `office_id`: معرف المكتب
- `parent_user_id`: معرف المستخدم الأب
- `is_active`: حالة الحساب
- `created_at`: تاريخ الإنشاء
- `updated_at`: تاريخ التحديث
- `last_login`: آخر تسجيل دخول

### 3. تفعيل Row Level Security (RLS)

تم تفعيل RLS وإنشاء السياسات التالية:
- **القراءة العامة**: يمكن للجميع قراءة البيانات
- **الإدراج**: يمكن للجميع إنشاء حسابات جديدة
- **التحديث**: يمكن للجميع تحديث البيانات
- **الحذف**: يمكن للجميع حذف البيانات

### 4. المستخدم الافتراضي

سيتم إنشاء:
- مكتب افتراضي: "المكتب الافتراضي"
- مستخدم admin: 
  - اسم المستخدم: `admin`
  - كلمة المرور: `admin123`
  - البريد الإلكتروني: `admin@example.com`

## اختبار النظام

### 1. تشغيل المشروع

```bash
npm run dev
```

### 2. اختبار التسجيل

1. اذهب إلى: `http://localhost:3000/register`
2. جرب إنشاء حساب جديد
3. تأكد من عدم تكرار اسم المستخدم أو البريد الإلكتروني

### 3. اختبار تسجيل الدخول

1. اذهب إلى: `http://localhost:3000/login`
2. جرب تسجيل الدخول بالحساب الجديد
3. جرب تسجيل الدخول بالمستخدم الافتراضي (admin/admin123)

## الملفات المهمة

- **`pages/api/auth/register-supabase.ts`** - API التسجيل
- **`pages/api/auth/login-supabase.ts`** - API تسجيل الدخول
- **`utils/supabase.ts`** - تكوين Supabase
- **`types/auth.ts`** - أنواع البيانات

## استكشاف الأخطاء

### مشكلة في الاتصال
- تأكد من تنفيذ أوامر SQL
- تحقق من صحة URL و API Key

### مشكلة في التسجيل
- تأكد من وجود الجداول
- تحقق من صحة السياسات
- راجع سجلات الأخطاء في Supabase

### مشكلة في تسجيل الدخول
- تأكد من تشفير كلمات المرور
- تحقق من حالة الحساب (is_active)

## الخطوات التالية

بعد التأكد من عمل نظام المصادقة:

1. إضافة التحقق من البريد الإلكتروني
2. إضافة استعادة كلمة المرور
3. إضافة تحديث الملف الشخصي
4. إضافة إدارة المستخدمين للمشرفين
5. إضافة نظام الأدوار والصلاحيات

## ملاحظات أمنية

- في الإنتاج، استخدم مفتاح JWT قوي
- فعّل HTTPS
- أضف rate limiting
- أضف logging للأحداث الأمنية
- راجع السياسات حسب متطلبات الأمان

## روابط مفيدة

- [Supabase Auth](https://supabase.com/docs/guides/auth)
- [Row Level Security](https://supabase.com/docs/guides/auth/row-level-security)
- [JWT Best Practices](https://supabase.com/docs/guides/auth/row-level-security)
